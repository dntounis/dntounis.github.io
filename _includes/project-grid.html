{% comment %}
This template handles both individual category views and the main projects page.
It includes proper handling of math rendering and toggle functionality.
{% endcomment %}

<div class="projects-grid">
  {% assign sorted_projects = site.projects | sort: "order" | reverse %}
  
  {% if include.category %}
    <h2>{{ include.category | capitalize }} Projects</h2>
    {% assign filtered_projects = sorted_projects | where: "status", include.category %}
    {% for project in filtered_projects %}
      <div class="project-card">
        {% include project-card-content.html %}
      </div>
    {% endfor %}
  
  {% else %}
    {% comment %} Current Projects Section {% endcomment %}
    {% assign current_projects = sorted_projects | where: "status", "current" %}
    {% if current_projects.size > 0 %}
      <h2>Current Projects</h2>
      {% for project in current_projects %}
        <div class="project-card" data-category="current">
          {% include project-card-content.html %}
        </div>
      {% endfor %}
    {% endif %}

    {% comment %} Past Projects Section {% endcomment %}
    {% assign past_projects = sorted_projects | where: "status", "past" %}
    {% if past_projects.size > 0 %}
      <h2>Past Projects</h2>
      {% for project in past_projects %}
        <div class="project-card" data-category="past">
          {% include project-card-content.html %}
        </div>
      {% endfor %}
    {% endif %}
  {% endif %}
</div>

{% comment %}
Create a new file _includes/project-card-content.html with the following content:
{% endcomment %}

{% capture project_card_content %}
  {% if project.image %}
    <div class="project-image-container">
      <img src="{{ project.image }}" 
           alt="{{ project.title }}" 
           class="project-image"
           loading="lazy">
    </div>
  {% endif %}
  
  <div class="project-content">
    <h3 class="project-title" onclick="toggleProject(this)">
      {{ project.title | markdownify | remove: '<p>' | remove: '</p>' }}
      <span class="expand-icon" aria-hidden="true">â–¼</span>
    </h3>
    
    <div class="project-description">
      {{ project.description | markdownify }}
    </div>
    
    <div class="project-details" aria-expanded="false">
      {{ project.content | markdownify }}
    </div>
    
    {% if project.tags %}
      <div class="project-tags">
        {% for tag in project.tags %}
          <span class="tag">{{ tag }}</span>
        {% endfor %}
      </div>
    {% endif %}
    
    <div class="project-links">
      {% if project.demo %}
        <a href="{{ project.demo }}" 
           class="project-link" 
           target="_blank" 
           rel="noopener noreferrer">
          <i class="fas fa-external-link-alt" aria-hidden="true"></i>
          Demo
        </a>
      {% endif %}
      
      {% if project.code %}
        <a href="{{ project.code }}" 
           class="project-link" 
           target="_blank" 
           rel="noopener noreferrer">
          <i class="fas fa-code" aria-hidden="true"></i>
          Code
        </a>
      {% endif %}
      
      {% if project.Paper %}
        <a href="{{ project.Paper }}" 
           class="project-link paper-link" 
           target="_blank" 
           rel="noopener noreferrer">
          <i class="fas fa-file-pdf" aria-hidden="true"></i>
          Paper
        </a>
      {% endif %}
    </div>
  </div>
{% endcapture %}

{% if include.content == "card" %}
  {{ project_card_content }}
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize all project details
  document.querySelectorAll('.project-details').forEach(details => {
    details.style.height = '0';
  });
});

function toggleProject(element) {
  const card = element.closest('.project-card');
  const details = card.querySelector('.project-details');
  const icon = element.querySelector('.expand-icon');
  
  if (!details || !icon) return;
  
  const isExpanded = details.getAttribute('aria-expanded') === 'true';
  
  if (!isExpanded) {
    // Expand
    details.style.height = 'auto';
    const height = details.scrollHeight;
    details.style.height = '0';
    // Force reflow
    details.offsetHeight;
    details.style.height = height + 'px';
    details.setAttribute('aria-expanded', 'true');
    icon.style.transform = 'rotate(180deg)';
    
    // After animation completes, set height to auto
    setTimeout(() => {
      details.style.height = 'auto';
    }, 300);
  } else {
    // Collapse
    const height = details.scrollHeight;
    details.style.height = height + 'px';
    // Force reflow
    details.offsetHeight;
    details.style.height = '0';
    details.setAttribute('aria-expanded', 'false');
    icon.style.transform = 'rotate(0)';
  }
}
</script>